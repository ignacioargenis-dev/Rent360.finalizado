<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Simple Rent360</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border-left: 4px solid #0070f3;
            background: #f8f9fa;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
        .code {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        button {
            background: #0070f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Debug Simple Rent360</h1>
        <p>Diagn√≥stico b√°sico sin hooks de React para identificar problemas.</p>
    </div>

    <div class="container">
        <div class="section">
            <h2>üåê Estado del Servidor</h2>
            <button onclick="testServerHealth()">Probar /api/health</button>
            <div id="health-results" class="test-result"></div>
        </div>

        <div class="section">
            <h2>üç™ Cookies del Navegador</h2>
            <button onclick="showCookies()">Mostrar Cookies</button>
            <div id="cookie-results" class="test-result"></div>
        </div>

        <div class="section">
            <h2>üîê Prueba B√°sica de Auth</h2>
            <button onclick="testBasicAuth()">Probar /api/auth/me (b√°sico)</button>
            <div id="auth-results" class="test-result"></div>
        </div>

        <div class="section">
            <h2>üîß Herramientas Avanzadas</h2>
            <button onclick="goToAdvancedDebug()">Ir a Debug Avanzado</button>
            <p><small>Requiere que el sistema funcione parcialmente</small></p>
        </div>

        <div class="section">
            <h2>üîí Content Security Policy (CSP)</h2>
        <button onclick="checkCSP()">Verificar CSP</button>
        <div id="csp-results" class="test-result"></div>

        <h2>üîÑ Service Worker</h2>
            <button onclick="updateServiceWorker()">Actualizar Service Worker</button>
            <div id="sw-results" class="test-result"></div>
        </div>

        <div class="section">
            <h2>üßπ Limpiar Cache del Navegador</h2>
            <button onclick="clearBrowserCache()">Forzar Recarga (Hard Refresh)</button>
            <div id="cache-results" class="test-result"></div>
        </div>

        <div class="section">
            <h2>üßπ Limpiar y Reiniciar</h2>
            <button class="danger" onclick="clearEverything()">Limpiar Todo y Reiniciar</button>
            <div id="clear-results" class="test-result"></div>
        </div>
    </div>

    <script>
        // Funci√≥n para probar la salud del servidor
        async function testServerHealth() {
            const results = document.getElementById('health-results');
            results.innerHTML = '<p>üîÑ Probando servidor...</p>';
            results.className = 'test-result';

            try {
                const response = await fetch('/api/health');

                let html = `<h3>Estado del Servidor:</h3>`;
                html += `<p><strong>Status:</strong> ${response.status} ${response.statusText}</p>`;
                html += `<p><strong>OK:</strong> ${response.ok ? '‚úÖ' : '‚ùå'}</p>`;

                if (response.ok) {
                    html += '<p class="success">‚úÖ Servidor responde correctamente</p>';
                    try {
                        const data = await response.json();
                        html += `<pre class="code">${JSON.stringify(data, null, 2)}</pre>`;
                    } catch (e) {
                        html += '<p>Respuesta no es JSON v√°lido</p>';
                    }
                    results.className = 'test-result success';
                } else {
                    html += '<p class="error">‚ùå Servidor tiene problemas</p>';
                    results.className = 'test-result error';
                }

                results.innerHTML = html;

            } catch (error) {
                results.innerHTML = `<p class="error">‚ùå Error de conexi√≥n: ${error.message}</p>`;
                results.className = 'test-result error';
            }
        }

        // Funci√≥n para mostrar cookies
        function showCookies() {
            const results = document.getElementById('cookie-results');
            const cookies = document.cookie.split(';');
            const cookieObj = {};

            cookies.forEach(cookie => {
                const [name, value] = cookie.trim().split('=');
                if (name) cookieObj[name] = value || '';
            });

            let html = '<h3>Cookies encontradas:</h3>';
            html += `<p><strong>Total:</strong> ${Object.keys(cookieObj).length}</p>`;

            if (Object.keys(cookieObj).length > 0) {
                html += '<ul>';
                Object.keys(cookieObj).forEach(name => {
                    const value = cookieObj[name];
                    const truncatedValue = value ? `${value.substring(0, 30)}...` : 'vac√≠o';
                    html += `<li><strong>${name}:</strong> ${truncatedValue}</li>`;
                });
                html += '</ul>';
            } else {
                html += '<p class="warning">‚ö†Ô∏è No hay cookies. Necesitas hacer login.</p>';
            }

            // Verificar cookies espec√≠ficas
            const authToken = cookieObj['auth-token'];
            const refreshToken = cookieObj['refresh-token'];

            html += '<h4>Cookies de autenticaci√≥n:</h4>';
            html += `<p><strong>auth-token:</strong> ${authToken ? '‚úÖ Presente' : '‚ùå Ausente'}</p>`;
            html += `<p><strong>refresh-token:</strong> ${refreshToken ? '‚úÖ Presente' : '‚ùå Ausente'}</p>`;

            results.innerHTML = html;
            results.className = 'test-result info';
        }

        // Funci√≥n para probar auth b√°sico
        async function testBasicAuth() {
            const results = document.getElementById('auth-results');
            results.innerHTML = '<p>üîÑ Probando autenticaci√≥n...</p>';
            results.className = 'test-result';

            try {
                const response = await fetch('/api/auth/me', {
                    method: 'GET',
                    credentials: 'include',
                });

                let html = `<h3>Respuesta de /api/auth/me:</h3>`;
                html += `<p><strong>Status:</strong> ${response.status} ${response.statusText}</p>`;
                html += `<p><strong>OK:</strong> ${response.ok ? '‚úÖ' : '‚ùå'}</p>`;

                if (response.ok) {
                    html += '<p class="success">‚úÖ Autenticaci√≥n exitosa</p>';
                    try {
                        const data = await response.json();
                        html += `<pre class="code">${JSON.stringify(data, null, 2)}</pre>`;
                    } catch (e) {
                        html += '<p>Error al parsear respuesta JSON</p>';
                    }
                    results.className = 'test-result success';
                } else if (response.status === 401) {
                    html += '<p class="warning">‚ö†Ô∏è Usuario no autenticado (esperado si no has hecho login)</p>';
                    results.className = 'test-result warning';
                } else if (response.status === 503) {
                    html += '<p class="error">‚ùå Error del servidor (503 Service Unavailable)</p>';
                    html += '<p><strong>Problema:</strong> El middleware est√° fallando</p>';
                    results.className = 'test-result error';
                } else {
                    html += `<p class="error">‚ùå Error inesperado (${response.status})</p>`;
                    results.className = 'test-result error';
                }

                results.innerHTML = html;

            } catch (error) {
                results.innerHTML = `<p class="error">‚ùå Error de red: ${error.message}</p>`;
                results.className = 'test-result error';
            }
        }

        // Funci√≥n para ir al debug avanzado
        function goToAdvancedDebug() {
            window.location.href = '/debug-auth.html';
        }

        // Funci√≥n para verificar CSP
        async function checkCSP() {
            const results = document.getElementById('csp-results');
            results.innerHTML = '<p>üîç Verificando CSP...</p>';
            results.className = 'test-result';

            try {
                // Intentar ejecutar eval para ver si est√° bloqueado
                let evalBlocked = false;
                try {
                    eval('console.log("CSP test")');
                } catch (e) {
                    evalBlocked = true;
                }

                // Verificar headers de respuesta
                const response = await fetch(window.location.href, { method: 'HEAD' });
                const cspHeader = response.headers.get('content-security-policy');

                let result = '<p>üìã Estado CSP:</p>';
                result += `<p>Eval bloqueado: ${evalBlocked ? '‚ùå S√ç' : '‚úÖ NO'}</p>`;
                result += `<p>CSP Header presente: ${cspHeader ? '‚úÖ S√ç' : '‚ùå NO'}</p>`;

                if (cspHeader) {
                    result += `<p><small>CSP: ${cspHeader.substring(0, 100)}...</small></p>`;
                }

                if (evalBlocked && cspHeader && cspHeader.includes('unsafe-eval')) {
                    result += '<p>‚ö†Ô∏è CSP incluye unsafe-eval pero eval sigue bloqueado - posible cache del navegador</p>';
                }

                results.innerHTML = result;
                results.className = evalBlocked ? 'test-result error' : 'test-result success';
            } catch (error) {
                results.innerHTML = `<p class="error">‚ùå Error verificando CSP: ${error.message}</p>`;
                results.className = 'test-result error';
            }
        }

        // Funci√≥n para actualizar service worker
        async function updateServiceWorker() {
            const results = document.getElementById('sw-results');
            results.innerHTML = '<p>üîÑ Actualizando Service Worker...</p>';
            results.className = 'test-result';

            try {
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.ready;

                    // Forzar actualizaci√≥n
                    await registration.update();

                    // Limpiar caches antiguos
                    const cacheNames = await caches.keys();
                    await Promise.all(
                        cacheNames.map(cacheName => {
                            if (cacheName.startsWith('rent360-') && !cacheName.includes('v1.0.1')) {
                                console.log('Eliminando cache antiguo:', cacheName);
                                return caches.delete(cacheName);
                            }
                        })
                    );

                    results.innerHTML = `<p class="success">‚úÖ Service Worker actualizado y caches limpiados. Recarga la p√°gina para activar los cambios.</p>`;
                    results.className = 'test-result success';
                } else {
                    results.innerHTML = `<p class="warning">‚ö†Ô∏è Service Worker no soportado en este navegador.</p>`;
                    results.className = 'test-result warning';
                }
            } catch (error) {
                results.innerHTML = `<p class="error">‚ùå Error actualizando Service Worker: ${error.message}</p>`;
                results.className = 'test-result error';
            }
        }

        // Funci√≥n para limpiar cache del navegador
        function clearBrowserCache() {
            const results = document.getElementById('cache-results');
            results.innerHTML = '<p>üîÑ Forzando recarga completa...</p>';
            results.className = 'test-result';

            try {
                // Limpiar caches del navegador
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                        });
                    });
                }

                // Forzar recarga hard refresh
                window.location.reload(true);

                results.innerHTML = '<p class="success">‚úÖ Cache limpiado y recarga forzada iniciada</p>';
                results.className = 'test-result success';
            } catch (error) {
                results.innerHTML = `<p class="error">‚ùå Error limpiando cache: ${error.message}</p>`;
                results.className = 'test-result error';
            }
        }

        // Funci√≥n para limpiar todo
        function clearEverything() {
            const results = document.getElementById('clear-results');

            // Limpiar cookies
            document.cookie.split(";").forEach(function(c) {
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
            });

            // Limpiar localStorage
            localStorage.clear();
            sessionStorage.clear();

            results.innerHTML = `<p class="success">‚úÖ Cookies, localStorage y sessionStorage limpiados. Recarga la p√°gina.</p>`;
            results.className = 'test-result success';

            // Recargar despu√©s de 2 segundos
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }

        // Ejecutar pruebas iniciales
        window.onload = function() {
            showCookies();
            testServerHealth();
        };
    </script>
</body>
</html>
